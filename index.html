<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <title>miniSHA256.js</title>
    <link rel="stylesheet" href="utils/base.css">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Ubuntu:300');
        body,
        button,
        input,
        textarea,
        select,
        th,
        td,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Ubuntu', sans-serif;
        }
    </style>
</head>

<body>
    <h1>miniSHA256.js</h1>
    <p>
      <a href="https://github.com/tomaslangkaas/miniSHA256.js/blob/gh-pages/README.md">
        GitHub repository
      </a>
    </p>
    <p><button onclick="runTests(logResult)">Run tests</button></p>
    <p id="results"></p>

    <p>
      <button onclick="shaTests.reset();shaTests.run();">Run</button>
      <table>
        <tr><th>Test</th><th>Result</th><th>Elapsed time</th></tr>
<tr id="shaTest1"></tr>
<tr id="shaTest2"></tr>
</table>
    </p>

    <script src="src/miniSHA256.js"></script>
    <script src="utils/bico.js"></script>
    <script src="utils/Q.js"></script>
    <script src="test/sha-256-test-vectors.js"></script>
    <script type="text/javascript">
      bico(bico, 'fromBits', 'toBits', '01', 1);

      var shaTests = Q(
        function(state){},
        function(testID, message){
          document.getElementById(testID).innerHTML = '<td>' + testID +
          '</td><td>passed ' + message[0] + ' of ' + message[1] +
          '</td><td>' + message[2] + ' ms</td>';
        },
        function(testID, progress){
          document.getElementById(testID).innerHTML = '<td>' + testID +
          '</td><td>' + ((progress * 100) | 0) + ' %</td><td></td>';
        }
      );

      shaTests.task(
        'shaTest1',
        function(){
          return function(done){
            var pass = 0,
                date = +new Date,
                i, result,
                set = SHA256TestVectors['set 1'];

            for(i = 0; i < 8; i++){
              result = miniSHA256().digest(
                set[i].message,
                set[i].messageLength
              );
              if('' + result === '' + set[i].hash){
                pass++;
              }
            }
            done([pass, i, (+new Date) - date]);
          }
        }
      );

      shaTests.task(
        'shaTest2',
        function(){
          var message = [],
              date = +new Date,
              pass = 0,
              count = 1,
              iter = 5000,
              limit = 0;
              set = SHA256TestVectors['set 4'];
          message = miniSHA256().digest(
            message,
            256
          );
          if('' + message === '' + set.hash){
            pass++;
          }
          return function(onComplete, onProgress){
            limit += iter;
            var startDate = +new Date;
            for(count; count < 1e5 && count < limit; count++){
              message = miniSHA256().digest(
                message,
                256
              );
            }
            iter = iter * 50 /((+new Date) - startDate);
            console.log(iter, (+new Date) - startDate);
            if(count == 1e5){
              onComplete([
                pass + ('' + message === '' + set.hash1e5),
                2,
                (+new Date) - date
              ]);
            } else {
              onProgress(count / 1e5);
            }
          }
        }
      );

      function runTests(report){
        var vectors = SHA256TestVectors,
        set = vectors['set 1'],
        i, result, pass = 0, total = 0,
        message = [],
        failed = [],
        date = +new Date;
        function assert(actual, expected, failMessage){
          total++;
          if('' + actual === '' + expected){
            pass++;
          }else{
            failed.push(failMessage, actual, expected);
          }
        }
        //set 1, vectors #0-#7
        for(i = 0; i < 8; i++){
          result = miniSHA256().digest(
            set[i].message,
            set[i].messageLength
          );
          assert(result, set[i].hash);
        }
        report(pass, total, (+new Date) - date);
        //set 2, 1024 vectors
        set = vectors['set 2'];
        for(i = 0; i < set.length/8; i++){
          result = miniSHA256()
            .digest(message, i);
          assert(result, set.slice(i * 8, i * 8 + 8));
        }
        report(pass, total, (+new Date) - date);
        //set 3, 512 vectors
        set = vectors['set 3'];
        for(i = 0; i < set.length/8; i++){
          //place 1 at bit position i in 512 bit array
          message[i >>> 5] = 1 << (31 - (i & 31));
          result = miniSHA256().digest(message, 512);
          //reset bit position to 0
          message[i >>> 5] = 0;
          assert(result, set.slice(i * 8, i * 8 + 8));
        }
        report(pass, total, (+new Date) - date);
      }

      function logResult(pass, total, time){
        document.getElementById('results').innerHTML = 'Passed ' + pass + ' of ' + total + ' tests, ' + time + ' ms';
      }
    </script>
  </body>
</html>
